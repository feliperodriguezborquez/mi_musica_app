{% extends "base.html" %}

{% block content %}
    <div class="detalle-obra">
        <div class="detalle-header">
            <a href="{{ url_for('index') }}" class="btn-volver">← Volver al Catálogo</a>
            {% if session.logged_in %}
                <a href="{{ url_for('edit_cancion', comp_id=obra.id) }}" class="btn-editar">✏️ Editar</a>
            {% endif %}
        </div>

        <h2>{{ obra.titulo }}</h2>
        
        <div class="metadata-grid">
            <span class="metadata-label">Música</span>
            <span class="metadata-value">{{ obra.musica }}</span>
            <span class="metadata-label">Letra</span>
            <span class="metadata-value">{{ obra.letra }}</span>
            <span class="metadata-label">Idioma</span>
            <span class="metadata-value">{{ obra.idioma }}</span>
            <span class="metadata-label">Año</span>
            <span class="metadata-value">{{ obra.anio }}</span>
            <span class="metadata-label">Descripción</span>
            <span class="metadata-value">{{ obra.descripcion }}</span>
        </div>

        {% if obra.tipo == 'local' %}
            <h4>Audio</h4>
            <audio controls class="reproductor">
                <source src="{{ url_for('static', filename=obra.audio) }}" type="audio/mpeg">
                Tu navegador no soporta el elemento de audio.
            </audio>
            {% if obra.partitura %}
                <h4>Partitura</h4>
                <embed src="{{ url_for('static', filename=obra.partitura) }}" type="application/pdf" width="100%" height="700px" />
            {% endif %}
        
        {% elif obra.tipo == 'youtube_selectable' %}
            <h4>Reproductor</h4>
            <div class="player-selection-buttons">
                <button class="player-button" onclick="showPlayer('audio')">Escuchar Canción</button>
                <button class="player-button" onclick="showPlayer('video')">Ver Video</button>
            </div>
            <div id="audioPlayer" class="embed-container">
                {{ obra.youtube_audio_embed | safe }}
            </div>
            <div id="videoPlayer" class="embed-container" style="display:none;">
                {{ obra.youtube_video_embed | safe }}
            </div>
            <script>
                function showPlayer(type) {
                    const videoPlayer = document.getElementById('videoPlayer');
                    const audioPlayer = document.getElementById('audioPlayer');
                    const videoButton = document.querySelector('.player-button[onclick*="video"]');
                    const audioButton = document.querySelector('.player-button[onclick*="audio"]');
                    if (type === 'video') {
                        videoPlayer.style.display = 'block';
                        audioPlayer.style.display = 'none';
                        videoButton.classList.add('active');
                        audioButton.classList.remove('active');
                    } else {
                        videoPlayer.style.display = 'none';
                        audioPlayer.style.display = 'block';
                        audioButton.classList.add('active');
                        videoButton.classList.remove('active');
                    }
                }
                document.addEventListener('DOMContentLoaded', () => {
                    showPlayer('audio');
                });
            </script>
        {% endif %}

        {% if obra.tags %}
            <h4>Listas de Reproducción</h4>
            <div class="tags-container">
                {% for tag in obra.tags %}
                    {% set parts = tag.split(':', 1) %}
                    
                    {% if parts|length > 1 %}
                        {# Si el tag es jerárquico (ej: "Cat: Sub"), crea dos botones #}
                        {% set categoria = parts[0] | trim %}
                        {% set sub_etiqueta = parts[1] | trim %}
                        
                        <a href="{{ url_for('ver_tag', tag_name=categoria) }}" class="tag-link">{{ categoria }}</a>
                        
                        <a href="{{ url_for('ver_tag', tag_name=tag) }}" class="tag-link">{{ sub_etiqueta }}</a>

                    {% else %}
                        {# Si el tag es simple, crea un solo botón #}
                        <a href="{{ url_for('ver_tag', tag_name=tag) }}" class="tag-link">{{ tag }}</a>
                    {% endif %}

                {% endfor %}
            </div>
        {% endif %}

        <div class="comentarios-seccion">
            <h4>Comentarios</h4>
            <form action="{{ url_for('add_comment', comp_id=obra.id) }}" method="post" class="comentario-form">
                <input type="text" name="autor" placeholder="Tu nombre" required>
                <textarea name="contenido" rows="4" placeholder="Escribe tu comentario..." required></textarea>
                <button type="submit">Enviar Comentario</button>
            </form>
            <div class="lista-comentarios">
                {% for comentario in comentarios %}
                    <div class="comentario">
                        <div class="comentario-header">
                            <p><strong>{{ comentario.autor }}</strong> <span class="fecha-comentario">{{ comentario.fecha_creacion.strftime('%d-%m-%Y') }}</span></p>
                            
                            {% if session.logged_in %}
                                <form method="post" action="{{ url_for('delete_comment', comment_id=comentario.id) }}" onsubmit="return confirm('¿Estás seguro de que quieres borrar este comentario?');">
                                    <button type="submit" class="btn-borrar-comentario">Borrar</button>
                                </form>
                            {% endif %}
                        </div>
                        <p class="comentario-contenido">{{ comentario.contenido }}</p>
                    </div>
                {% else %}
                    <p>Aún no hay comentarios. ¡Sé el primero!</p>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}